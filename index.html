<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY SHIFT | Suivi Temps Professionnel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #8b5cf6;
            --secondary: #06d6a0;
            --accent: #f59e0b;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --success: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --gray-lighter: #f1f5f9;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --gradient: linear-gradient(135deg, var(--primary), var(--primary-light));
            --gradient-dark: linear-gradient(135deg, var(--primary-dark), var(--primary));
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
            transition: all 0.5s ease-in-out;
        }

        body.status-prod {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        body.status-pause {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        body.status-formation {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        body.status-brief {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        body.status-deco {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .container {
            width: 100%;
            max-width: 1400px;
            animation: fadeIn 0.8s ease-out;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 440px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 35px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: var(--gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .login-header h1 {
            color: var(--dark);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-header p {
            color: var(--gray);
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--gray);
            padding: 6px;
            border-radius: 6px;
        }

        .toggle-password:hover {
            color: var(--primary);
            background: var(--gray-light);
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .sync-status {
            text-align: center;
            font-size: 13px;
            color: var(--gray);
            margin-top: 16px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(100, 116, 139, 0.05);
        }

        .sync-status.success { color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .sync-status.error { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .sync-status.warning { color: var(--warning); background: rgba(245, 158, 11, 0.1); }

        .app-container {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.6s ease-out;
        }

        .app-header {
            background: var(--gradient-dark);
            color: white;
            padding: 25px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-info {
            text-align: left;
        }

        .agent-info h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .agent-role {
            font-size: 13px;
            opacity: 0.9;
        }

        .datetime-info {
            text-align: right;
        }

        #clock {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 4px;
            font-feature-settings: "tnum";
        }

        #date {
            font-size: 14px;
            opacity: 0.9;
        }

        .app-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            align-items: start;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .status-section {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
        }

        .status-indicator {
            text-align: center;
            margin-bottom: 20px;
        }

        #statusText {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        #liveInfo {
            font-size: 14px;
            color: var(--gray);
        }

        .status-pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .btn-status {
            padding: 16px 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-height: 70px;
            position: relative;
            overflow: hidden;
        }

        .btn-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-status:hover::before {
            left: 100%;
        }

        .btn-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .btn-status.active {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.8);
        }

        .btn-status i {
            font-size: 18px;
        }

        .btn-status.prod { background: linear-gradient(135deg, var(--success), #059669); }
        .btn-status.pause { background: linear-gradient(135deg, var(--warning), #d97706); }
        .btn-status.formation { background: linear-gradient(135deg, var(--info), #2563eb); }
        .btn-status.brief { background: linear-gradient(135deg, var(--primary-light), #7c3aed); }
        .btn-status.deco { background: linear-gradient(135deg, var(--danger), #dc2626); }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .totals-card {
            background: white;
            padding: 0;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            overflow: hidden;
        }

        .totals-header {
            background: var(--gradient);
            color: white;
            padding: 18px 20px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .totals-header i {
            font-size: 16px;
        }

        .totals-table {
            width: 100%;
            border-collapse: collapse;
        }

        .totals-table tr {
            border-bottom: 1px solid var(--gray-lighter);
        }

        .totals-table tr:last-child {
            border-bottom: none;
        }

        .totals-table td {
            padding: 16px 20px;
            font-size: 14px;
        }

        .totals-table td:first-child {
            font-weight: 500;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.prod { background: var(--success); }
        .status-dot.pause { background: var(--warning); }
        .status-dot.formation { background: var(--info); }
        .status-dot.brief { background: var(--primary-light); }
        .status-dot.deco { background: var(--danger); }

        .totals-table td:last-child {
            text-align: right;
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
            font-feature-settings: "tnum";
            font-family: 'Courier New', monospace;
        }

        .logout-section {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            text-align: center;
            margin-top: auto;
        }

        .btn-logout {
            padding: 12px 24px;
            background: transparent;
            color: var(--gray);
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            transform: translateY(-1px);
        }

        .export-section {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            display: none;
        }

        .export-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .export-select {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .export-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Style amélioré pour le sélecteur de mois */
        .month-picker-container {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .month-picker {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .month-picker:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .date-picker {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .date-picker:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .export-type-select {
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .export-type-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-export {
            padding: 12px 24px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-export:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .admin-panel {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-light);
            margin-top: 20px;
        }

        .admin-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .admin-header h3 {
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-select {
            padding: 10px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
        }

        .btn-admin {
            padding: 12px 20px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-admin.danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-admin.warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .agents-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            padding: 10px;
        }

        .agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--gray-lighter);
            transition: all 0.3s ease;
        }

        .agent-item:hover {
            background: var(--gray-lighter);
        }

        .agent-item:last-child {
            border-bottom: none;
        }

        .agent-info-small {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .agent-email {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
        }

        .agent-name {
            font-size: 12px;
            color: var(--gray);
        }

        .agent-status {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .agent-time {
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: var(--dark);
            margin-left: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .status-badge.prod { background: var(--success); }
        .status-badge.pause { background: var(--warning); }
        .status-badge.formation { background: var(--info); }
        .status-badge.brief { background: var(--primary-light); }
        .status-badge.deco { background: var(--danger); }
        .status-badge.none { background: var(--gray); }
        .status-badge.connected { background: var(--success); }
        .status-badge.disconnected { background: var(--danger); }

        /* Styles pour les boutons désactivés */
        .btn-status:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-status:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-status:disabled::before {
            display: none;
        }

        .time-warning {
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .date-range-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .date-range-container .date-picker {
            flex: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }

        @media (max-width: 1024px) {
            .app-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                order: -1;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }
            
            .export-controls {
                flex-direction: column;
            }
            
            .export-select, .month-picker-container, .date-range-container {
                min-width: 100%;
            }
            
            .date-range-container {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .login-card, .app-container {
                border-radius: 16px;
                padding: 25px 20px;
            }

            .app-header {
                padding: 20px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .app-content {
                padding: 20px;
            }

            .datetime-info {
                text-align: center;
            }

            #clock {
                font-size: 28px;
            }

            .buttons-grid {
                grid-template-columns: 1fr;
            }

            .btn-status {
                min-height: 60px;
                padding: 14px 12px;
            }

            .status-section {
                padding: 20px;
            }

            #statusText {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Vue Connexion -->
        <div class="login-card" id="loginView">
            <div class="login-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <h1>MY SHIFT</h1>
                <p>Suivi professionnel du temps de travail</p>
            </div>
            
            <div class="form-group">
                <label for="firstName"><i class="fas fa-user"></i> Prénom</label>
                <input type="text" id="firstName" placeholder="Votre prénom" required>
            </div>
            
            <div class="form-group">
                <label for="lastName"><i class="fas fa-user-tag"></i> Nom</label>
                <input type="text" id="lastName" placeholder="Votre nom" required>
            </div>
            
            <div class="form-group">
                <label for="email"><i class="fas fa-envelope"></i> Email</label>
                <input type="email" id="email" placeholder="votre@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Mot de passe</label>
                <div class="password-container">
                    <input type="password" id="password" placeholder="Votre mot de passe" required>
                    <button type="button" class="toggle-password" id="togglePassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <button class="btn-login" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            
            <div class="login-error" id="loginError"></div>
            <div class="sync-status" id="syncStatus">
                <i class="fas fa-cloud"></i> Connexion à la base de données...
            </div>
        </div>

        <!-- Vue Application -->
        <div class="app-container" id="appView">
            <div class="app-header">
                <div class="agent-info">
                    <h2 id="agentName">Agent</h2>
                    <div class="agent-role" id="agentRole">Suivi en temps réel</div>
                </div>
                <div class="datetime-info">
                    <div id="clock">--:--:--</div>
                    <div id="date">-- -- ----</div>
                </div>
            </div>
            
            <div class="app-content">
                <!-- Contenu principal -->
                <div class="main-content">
                    <!-- Section Statut -->
                    <div class="status-section">
                        <div class="status-indicator">
                            <div id="statusText">Aucun statut sélectionné</div>
                            <div id="liveInfo">
                                <span class="status-pulse"></span>
                                Choisissez un statut pour démarrer le suivi
                            </div>
                        </div>
                        
                        <!-- Boutons Statut -->
                        <div class="buttons-grid">
                            <button class="btn-status prod" id="btnProd">
                                <i class="fas fa-play-circle"></i>
                                En production
                            </button>
                            <button class="btn-status pause" id="btnPause">
                                <i class="fas fa-coffee"></i>
                                Pause
                            </button>
                            <button class="btn-status formation" id="btnFormation">
                                <i class="fas fa-graduation-cap"></i>
                                Formation
                            </button>
                            <button class="btn-status brief" id="btnBrief">
                                <i class="fas fa-users"></i>
                                Briefing
                            </button>
                            <button class="btn-status deco" id="btnDeco">
                                <i class="fas fa-power-off"></i>
                                Déconnecté
                            </button>
                        </div>
                        <div class="sync-status" id="appSyncStatus" style="margin-top: 15px;">
                            <i class="fas fa-sync"></i> Synchronisation...
                        </div>
                    </div>

                    <!-- Section Export Admin -->
                    <div class="export-section" id="exportSection">
                        <div class="export-controls">
                            <select class="export-select" id="exportAgentSelect">
                                <option value="">Sélectionner un agent par email</option>
                                <option value="all">📊 EXTRACTION GROUPÉE (Tous les agents)</option>
                            </select>
                            
                            <select class="export-type-select" id="exportType">
                                <option value="daily">Journalier</option>
                                <option value="monthly">Mensuel</option>
                                <option value="range">Période personnalisée</option>
                            </select>
                            
                            <div class="date-picker-container" id="dailyDateContainer">
                                <input type="date" class="date-picker" id="exportDailyDate" value="">
                            </div>
                            
                            <div class="month-picker-container" id="monthlyDateContainer" style="display: none;">
                                <input type="month" class="month-picker" id="exportMonth" value="">
                            </div>
                            
                            <div class="date-range-container" id="dateRangeContainer" style="display: none;">
                                <input type="date" class="date-picker" id="exportStartDate" value="">
                                <span>à</span>
                                <input type="date" class="date-picker" id="exportEndDate" value="">
                            </div>
                            
                            <button class="btn-export" id="exportBtn">
                                <i class="fas fa-file-export"></i>
                                Exporter les données
                            </button>
                        </div>
                        <div class="sync-status" id="exportStatus" style="display: none;"></div>
                    </div>

                    <!-- Panel Admin -->
                    <div class="admin-panel" id="adminPanel" style="display: none;">
                        <div class="admin-header">
                            <i class="fas fa-user-shield"></i>
                            <h3>PANEL ADMINISTRATEUR</h3>
                        </div>
                        
                        <div class="admin-controls">
                            <select class="admin-select" id="adminAgentSelect">
                                <option value="">Sélectionner un agent par email</option>
                            </select>
                            <select class="admin-select" id="adminStatusSelect">
                                <option value="En prod">En production</option>
                                <option value="Pause">Pause</option>
                                <option value="Formation">Formation</option>
                                <option value="Brief">Briefing</option>
                                <option value="Déconnecté">Déconnecté</option>
                            </select>
                            <button class="btn-admin" id="adminSetStatusBtn">
                                <i class="fas fa-cog"></i>
                                Forcer le statut
                            </button>
                            <button class="btn-admin danger" id="adminDisconnectBtn">
                                <i class="fas fa-power-off"></i>
                                Forcer déconnexion
                            </button>
                            <button class="btn-admin" id="adminRefreshBtn" style="grid-column: 1 / -1;">
                                <i class="fas fa-sync-alt"></i>
                                Actualiser la liste
                            </button>
                        </div>
                        
                        <!-- NOUVELLE SECTION POUR LA RÉINITIALISATION -->
                        <div class="admin-controls" style="margin-top: 20px; border-top: 1px solid var(--gray-light); padding-top: 20px;">
                            <div style="grid-column: 1 / -1; text-align: center;">
                                <button class="btn-admin warning" id="adminResetTotalsBtn">
                                    <i class="fas fa-eraser"></i>
                                    Réinitialiser Mes Totaux
                                </button>
                                <div style="font-size: 12px; color: var(--gray); margin-top: 8px;">
                                    Cette action remet à zéro uniquement VOS totaux actuels
                                </div>
                            </div>
                        </div>
                        
                        <div class="sync-status" id="adminStatus" style="margin-top: 10px; display: none;"></div>
                        
                        <h4 style="margin: 15px 0 10px 0; font-size: 14px; color: var(--dark);">
                            <i class="fas fa-users"></i> Statut des agents en temps réel
                        </h4>
                        <div class="agents-list" id="agentsList">
                            <!-- Liste des agents dynamique -->
                        </div>
                    </div>
                </div>

                <!-- Barre latérale droite -->
                <div class="sidebar">
                    <!-- Tableau des totaux -->
                    <div class="totals-card">
                        <div class="totals-header">
                            <i class="fas fa-chart-bar"></i>
                            TEMPS CUMULÉS
                        </div>
                        <table class="totals-table">
                            <tr>
                                <td>
                                    <span class="status-dot prod"></span>
                                    Production
                                </td>
                                <td id="tProd">00:00:00</td>
                            </tr>
                            <tr>
                                <td>
                                    <span class="status-dot pause"></span>
                                    Pause
                                </td>
                                <td id="tPause">00:00:00</td>
                            </tr>
                            <tr>
                                <td>
                                    <span class="status-dot formation"></span>
                                    Formation
                                </td>
                                <td id="tFormation">00:00:00</td>
                            </tr>
                            <tr>
                                <td>
                                    <span class="status-dot brief"></span>
                                    Briefing
                                </td>
                                <td id="tBrief">00:00:00</td>
                            </tr>
                            <tr>
                                <td>
                                    <span class="status-dot deco"></span>
                                    Déconnecté
                                </td>
                                <td id="tDeco">00:00:00</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Bouton Déconnexion -->
                    <div class="logout-section">
                        <button class="btn-logout" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Déconnexion
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script>
        // Configuration Supabase
        const SUPABASE_URL = "https://azqbdnhgyolmwmvxfowb.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cWJkbmhneW9sbXdtdnhmb3diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MzkzNDMsImV4cCI6MjA3NjExNTM0M30.swJva7IonZm-hwE40-udUBZTrCmtj8xeaFCtcPNoC9Q";

        // Initialisation Supabase
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('✅ Supabase initialisé');
        } catch (error) {
            console.error('❌ Erreur Supabase:', error);
        }

        // Variables globales
        let current = null;
        let totals = {'En prod':0,'Pause':0,'Formation':0,'Brief':0,'Déconnecté':0};
        let dayKey = null;
        let elapsedTimer = null;
        let clockTimer = null;
        let currentUser = null;
        let autoSaveInterval = null;
        let realtimeSubscription = null;
        let isAdmin = false;
        let allAgents = [];

        // ==================== GESTION HISTORIQUE LOCAL ====================

        function saveToHistory(status, startTime, endTime, duration) {
            const history = JSON.parse(localStorage.getItem('myShiftHistory') || '[]');
            
            history.push({
                date: dayKey,
                status: status,
                start: startTime.toISOString(),
                end: endTime.toISOString(),
                duration: duration, // en secondes
                timestamp: new Date().toISOString(),
                userEmail: currentUser?.email || 'unknown'
            });
            
            // Garder seulement les 90 derniers jours pour éviter que le localStorage soit trop lourd
            const filteredHistory = history.filter(entry => {
                const entryDate = new Date(entry.date);
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                return entryDate >= ninetyDaysAgo;
            });
            
            localStorage.setItem('myShiftHistory', JSON.stringify(filteredHistory));
            console.log('💾 Historique sauvegardé:', status, duration + 's');
        }

        function loadHistory() {
            return JSON.parse(localStorage.getItem('myShiftHistory') || '[]');
        }

        function clearOldHistory() {
            const history = loadHistory();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 90);
            
            const filteredHistory = history.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= thirtyDaysAgo;
            });
            
            localStorage.setItem('myShiftHistory', JSON.stringify(filteredHistory));
        }

        // ==================== GESTION DES HORAIRES ====================

        function getCurrentTime() {
            return new Date();
        }

        function isWithinWorkingHours() {
            const now = getCurrentTime();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // Entre 8h00 et 19h30
            if (hours < 8) return false;
            if (hours > 19) return false;
            if (hours === 19 && minutes >= 30) return false;
            
            return true;
        }

        function isWithinAdminAccessHours() {
            const now = getCurrentTime();
            const hours = now.getHours();
            
            // Admin peut accéder 24h/24
            return true;
        }

        function isWithinAgentAccessHours() {
            const now = getCurrentTime();
            const hours = now.getHours();
            
            // Agents peuvent accéder 24h/24 (consultation seule en dehors des horaires de travail)
            return true;
        }

        function updateAccessBasedOnTime() {
            const isWorkingTime = isWithinWorkingHours();
            
            if (!isAdmin) {
                // Pour les agents - accès 24h/24 mais modification seulement pendant les horaires de travail
                const statusButtons = document.querySelectorAll('.btn-status');
                statusButtons.forEach(btn => {
                    btn.disabled = !isWorkingTime;
                    if (!isWorkingTime) {
                        btn.style.opacity = '0.6';
                        btn.style.cursor = 'not-allowed';
                    } else {
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                });
                
                // Message d'information pour les agents
                const statusIndicator = document.querySelector('.status-indicator');
                let existingWarning = statusIndicator.querySelector('.time-warning');
                
                if (!isWorkingTime) {
                    if (!existingWarning) {
                        const warning = document.createElement('div');
                        warning.className = 'time-warning sync-status warning';
                        warning.style.marginTop = '10px';
                        const now = getCurrentTime();
                        const hours = now.getHours();
                        
                        if (hours < 8) {
                            warning.innerHTML = `<i class="fas fa-clock"></i> Consultation seule - Les modifications seront possibles à partir de 8h00`;
                        } else if (hours >= 19 && hours <= 23) {
                            warning.innerHTML = `<i class="fas fa-clock"></i> Consultation seule - Les modifications reprendront demain à 8h00`;
                        } else {
                            warning.innerHTML = `<i class="fas fa-clock"></i> Consultation seule - Hors horaire de travail (8h-19h30)`;
                        }
                        
                        statusIndicator.appendChild(warning);
                    }
                } else {
                    // Supprimer le message d'avertissement si on est dans les horaires de travail
                    if (existingWarning) {
                        existingWarning.remove();
                    }
                }
            }
        }

        // ==================== FONCTIONS DE BASE ====================

        function secToMin(seconds) {
            return Math.floor(seconds / 60);
        }

        function minToSec(minutes) {
            return minutes * 60;
        }

        function fmtHMS(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function fmtMS(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function todayKey(d = new Date()) {
            return d.toISOString().split('T')[0];
        }

        // ==================== GESTION SESSION ====================

        function saveCurrentSession() {
            if (currentUser) {
                const sessionData = {
                    user: currentUser,
                    isAdmin: isAdmin,
                    timestamp: Date.now()
                };
                localStorage.setItem('myShiftCurrentSession', JSON.stringify(sessionData));
            }
        }

        function loadCurrentSession() {
            const saved = localStorage.getItem('myShiftCurrentSession');
            if (saved) {
                try {
                    const sessionData = JSON.parse(saved);
                    const isRecent = (Date.now() - sessionData.timestamp) < (60 * 60 * 1000);
                    
                    if (isRecent && sessionData.user) {
                        return sessionData;
                    } else {
                        localStorage.removeItem('myShiftCurrentSession');
                    }
                } catch (e) {
                    localStorage.removeItem('myShiftCurrentSession');
                }
            }
            return null;
        }

        function clearCurrentSession() {
            localStorage.removeItem('myShiftCurrentSession');
            localStorage.removeItem('myShiftData');
        }

        function saveToLocalStorage() {
            const data = {
                totals: totals,
                current: current,
                dayKey: dayKey,
                userEmail: currentUser?.email
            };
            localStorage.setItem('myShiftData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('myShiftData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    if (data.dayKey === dayKey && data.userEmail === currentUser?.email) {
                        totals = data.totals || {'En prod':0,'Pause':0,'Formation':0,'Brief':0,'Déconnecté':0};
                        current = data.current || null;
                        
                        if (current && current.start) {
                            current.start = new Date(current.start);
                        }
                        
                        return true;
                    } else {
                        totals = {'En prod':0,'Pause':0,'Formation':0,'Brief':0,'Déconnecté':0};
                        current = null;
                        return false;
                    }
                } catch (e) {
                    return false;
                }
            }
            return false;
        }

        // ==================== INTERFACE UTILISATEUR ====================

        function updateButtonsAppearance(selectedStatus) {
            const buttons = {
                'En prod': document.getElementById('btnProd'),
                'Pause': document.getElementById('btnPause'),
                'Formation': document.getElementById('btnFormation'),
                'Brief': document.getElementById('btnBrief'),
                'Déconnecté': document.getElementById('btnDeco')
            };
            
            Object.values(buttons).forEach(btn => {
                if (btn) btn.classList.remove('active');
            });
            
            if (selectedStatus && buttons[selectedStatus]) {
                buttons[selectedStatus].classList.add('active');
            }

            updateBackgroundColor(selectedStatus);
        }

        function updateBackgroundColor(status) {
            document.body.classList.remove('status-prod', 'status-pause', 'status-formation', 'status-brief', 'status-deco');
            
            if (status) {
                let statusClass = '';
                switch(status) {
                    case 'En prod': statusClass = 'status-prod'; break;
                    case 'Pause': statusClass = 'status-pause'; break;
                    case 'Formation': statusClass = 'status-formation'; break;
                    case 'Brief': statusClass = 'status-brief'; break;
                    case 'Déconnecté': statusClass = 'status-deco'; break;
                }
                if (statusClass) {
                    document.body.classList.add(statusClass);
                }
            }
        }

        function updateTotalsUI(){
            const elements = {
                'En prod': document.getElementById('tProd'),
                'Pause': document.getElementById('tPause'),
                'Formation': document.getElementById('tFormation'),
                'Brief': document.getElementById('tBrief'),
                'Déconnecté': document.getElementById('tDeco')
            };
            
            for(const [status, element] of Object.entries(elements)){
                let totalSeconds = totals[status];
                
                if(current && current.status === status) {
                    const currentSeconds = Math.floor((Date.now() - current.start.getTime()) / 1000);
                    totalSeconds += currentSeconds;
                }
                
                element.textContent = fmtHMS(totalSeconds);
            }
            
            saveToLocalStorage();
        }

        function updateStatusDisplay(){
            const statusText = document.getElementById('statusText');
            const liveInfo = document.getElementById('liveInfo');
            
            if(current){
                const seconds = Math.floor((Date.now() - current.start.getTime()) / 1000);
                statusText.textContent = `${current.status} — ${fmtMS(seconds)}`;
                liveInfo.innerHTML = `<span class="status-pulse"></span>Statut actuel: ${current.status}`;
            } else {
                statusText.textContent = 'Aucun statut sélectionné';
                liveInfo.innerHTML = '<span class="status-pulse"></span>Choisissez un statut pour démarrer';
            }
        }

        // ==================== GESTION STATUT ====================

        async function setStatus(status){
            // Vérifier si on est après 19h30 (pour les agents)
            if (!isAdmin && !isWithinWorkingHours()) {
                alert('Modification du statut impossible en dehors des horaires de travail (8h-19h30)');
                return;
            }
            
            if(current && current.status === status) {
                return;
            }
            
            const previousStatus = current ? current.status : null;
            const previousStart = current ? current.start : null;
            
            if(current){
                const endTime = new Date();
                const secondsSpent = Math.floor((endTime - current.start.getTime()) / 1000);
                totals[current.status] += secondsSpent;
                
                // Sauvegarder dans l'historique local
                saveToHistory(current.status, current.start, endTime, secondsSpent);
            }
            
            current = { status, start: new Date() };
            
            updateButtonsAppearance(status);
            updateStatusDisplay();
            updateTotalsUI();
            startElapsedLoop();
            
            await saveToSupabase();
        }

        // ==================== FONCTIONS TEMPS ====================

        function startClock(){
            const clockEl = document.getElementById('clock');
            const dateEl = document.getElementById('date');
            
            if(clockTimer) clearInterval(clockTimer);
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString('fr-FR',{hour12:false});
            dateEl.textContent = now.toLocaleDateString('fr-FR',{weekday:'long', year:'numeric', month:'long', day:'numeric'});
            clockTimer = setInterval(() => {
                const now = new Date();
                clockEl.textContent = now.toLocaleTimeString('fr-FR',{hour12:false});
            }, 1000);
        }

        function startElapsedLoop(){
            if(elapsedTimer) clearInterval(elapsedTimer);
            elapsedTimer = setInterval(() => {
                if(!current) return;
                updateStatusDisplay();
                updateTotalsUI();
            }, 1000);
        }

        function startAutoSave(){
            if(autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(async () => {
                if(currentUser && current) {
                    await saveToSupabase();
                }
            }, 30000);
        }

        // ==================== FONCTIONS ADMIN CORRIGÉES ====================

        async function loadAllAgents() {
            if (!isAdmin) return;
            
            try {
                console.log('🔄 Chargement de tous les agents...');

                // Récupérer tous les utilisateurs depuis la vue sans doublons
                const { data: allUsers, error } = await supabase
                    .from('auth_users_unique')
                    .select('*')
                    .order('email');
                
                if (error) {
                    console.error('❌ Erreur auth_users_unique:', error);
                    throw error;
                }

                console.log('📊 Tous les utilisateurs récupérés:', allUsers);

                if (allUsers && allUsers.length > 0) {
                    // Filtrer pour exclure l'admin de la liste des agents
                    allAgents = allUsers.filter(user => user.email !== 'khyi.ahmed1@gmail.com');
                    await updateExportAgentSelect(allAgents);
                    await loadAgentsForAdmin();
                }
                
            } catch (error) {
                console.error('❌ Erreur chargement agents:', error);
            }
        }

        async function updateExportAgentSelect(users) {
            const exportSelect = document.getElementById('exportAgentSelect');
            const adminSelect = document.getElementById('adminAgentSelect');
            
            exportSelect.innerHTML = '<option value="">Sélectionner un agent par email</option><option value="all">📊 EXTRACTION GROUPÉE (Tous les agents)</option>';
            adminSelect.innerHTML = '<option value="">Sélectionner un agent par email</option>';
            
            for (const user of users) {
                const userEmail = user.email;
                const firstName = user.first_name || '';
                const lastName = user.last_name || '';
                
                const displayName = (firstName && lastName) 
                    ? `${userEmail} (${firstName} ${lastName})` 
                    : userEmail;

                // Ajouter à la liste d'export (TOUS les agents sauf admin)
                const exportOption = document.createElement('option');
                exportOption.value = user.id;
                exportOption.textContent = displayName;
                exportSelect.appendChild(exportOption);
            }
            
            console.log('✅ Liste export mise à jour avec', users.length, 'agents');
        }

        async function loadAgentsForAdmin() {
            if (!isAdmin) return;
            
            try {
                const agentsList = document.getElementById('agentsList');
                const adminSelect = document.getElementById('adminAgentSelect');
                
                agentsList.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 10px;">Chargement des utilisateurs...</div>';

                console.log('🔄 Chargement des agents pour admin...');

                // Récupérer les données du jour pour tous les agents AVEC le statut de connexion
                const { data: allTodayData, error: todayError } = await supabase
                    .from('shifts')
                    .select('user_id, current_status, connection_status, last_connection_update, en_prod, pause, formation, brief, deconnecte')
                    .eq('day_key', dayKey);

                if (todayError) {
                    console.error('❌ Erreur données du jour:', todayError);
                }

                console.log('📊 Données récupérées:', allTodayData);

                // Créer un map pour accéder rapidement aux données
                const todayDataMap = new Map();
                if (allTodayData) {
                    allTodayData.forEach(data => {
                        todayDataMap.set(data.user_id, data);
                    });
                }

                agentsList.innerHTML = '';
                adminSelect.innerHTML = '<option value="">Sélectionner un agent par email</option>';
                
                let connectedAgentsCount = 0;
                
                for (const user of allAgents) {
                    const userId = user.id;
                    const userEmail = user.email;
                    const firstName = user.first_name || '';
                    const lastName = user.last_name || '';
                    
                    // Récupérer les données depuis le map
                    const todayData = todayDataMap.get(userId);
                    
                    let currentStatus = 'Non connecté aujourd\'hui';
                    let statusClass = 'none';
                    let connectionInfo = '';
                    let connectionTime = '';
                    let isCurrentlyConnected = false;
                    
                    if (todayData) {
                        console.log(`🔍 Analyse ${userEmail}:`, todayData.connection_status);
                        
                        if (todayData.connection_status === 'Connecté') {
                            // Agent actuellement connecté
                            isCurrentlyConnected = true;
                            currentStatus = 'Connecté';
                            statusClass = 'connected';
                            connectionInfo = 'Connecté';
                            
                            // Ajouter l'heure de connexion si disponible
                            if (todayData.last_connection_update) {
                                const connectionDate = new Date(todayData.last_connection_update);
                                connectionTime = connectionDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                            }
                        } else if (todayData.connection_status === 'Déconnecté') {
                            // Agent déconnecté
                            currentStatus = 'Déconnecté';
                            statusClass = 'disconnected';
                            connectionInfo = 'Déconnecté';
                            if (todayData.last_connection_update) {
                                const connectionDate = new Date(todayData.last_connection_update);
                                connectionTime = connectionDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                            }
                        } else if (todayData.current_status) {
                            // Fallback sur l'ancien système (pour compatibilité)
                            currentStatus = todayData.current_status;
                            statusClass = getStatusClass(currentStatus);
                            connectionInfo = currentStatus;
                            // Considérer comme connecté si pas déconnecté
                            isCurrentlyConnected = currentStatus !== 'Déconnecté';
                        }
                    } else {
                        console.log(`❌ Aucune donnée pour ${userEmail} aujourd'hui`);
                    }
                    
                    // AJOUT IMPORTANT : NE montrer dans la liste déroulante admin QUE les agents ACTUELLEMENT connectés
                    if (isCurrentlyConnected) {
                        connectedAgentsCount++;
                        const displayName = (firstName && lastName) 
                            ? `${userEmail} (${firstName} ${lastName})` 
                            : userEmail;
                            
                        const adminOption = document.createElement('option');
                        adminOption.value = userId;
                        adminOption.textContent = displayName;
                        adminOption.setAttribute('data-status', currentStatus);
                        adminSelect.appendChild(adminOption);
                        console.log(`✅ Ajouté à la liste: ${userEmail}`);
                    }
                    
                    // Afficher dans la liste (TOUS les agents, même déconnectés)
                    const agentItem = document.createElement('div');
                    agentItem.className = 'agent-item';
                    
                    let statusDisplay = connectionInfo || currentStatus;
                    if (connectionTime) {
                        statusDisplay += ` (${connectionTime})`;
                    }
                    
                    agentItem.innerHTML = `
                        <div class="agent-info-small">
                            <div class="agent-email">${userEmail}</div>
                            <div class="agent-name">${firstName} ${lastName}</div>
                            <div class="agent-status">
                                <span class="status-badge ${statusClass}">${statusDisplay}</span>
                            </div>
                        </div>
                    `;
                    
                    agentsList.appendChild(agentItem);
                }
                
                console.log(`✅ Liste admin mise à jour avec ${connectedAgentsCount} agents connectés sur ${allAgents.length} agents totaux`);
                
                // Afficher un message si aucun agent n'est connecté
                if (connectedAgentsCount === 0) {
                    adminSelect.innerHTML = '<option value="">Aucun agent connecté actuellement</option>';
                    console.log('ℹ️ Aucun agent connecté détecté');
                }
                
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                agentsList.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">Erreur de chargement</div>';
            }
        }

        // Fonction pour obtenir la classe CSS du statut
        function getStatusClass(status) {
            switch(status) {
                case 'En prod': return 'prod';
                case 'Pause': return 'pause';
                case 'Formation': return 'formation';
                case 'Brief': return 'brief';
                case 'Déconnecté': return 'deco';
                default: return 'none';
            }
        }

        // FONCTION POUR RÉCUPÉRER L'EMAIL D'UN AGENT DEPUIS SON ID
        function getAgentEmailById(agentId) {
            const agent = allAgents.find(a => a.id === agentId);
            return agent ? agent.email : 'Email non trouvé';
        }

        // FONCTION POUR RÉCUPÉRER LE NOM COMPLET D'UN AGENT
        function getAgentFullName(agentId) {
            const agent = allAgents.find(a => a.id === agentId);
            if (!agent) return 'Agent non trouvé';
            const firstName = agent.first_name || '';
            const lastName = agent.last_name || '';
            return (firstName && lastName) ? `${firstName} ${lastName}` : 'Nom non renseigné';
        }

        // FONCTION OPTIMISÉE POUR METTRE À JOUR UN SEUL AGENT
        function updateSingleAgentInList(agentId, newStatus, isConnectionUpdate = false) {
            const agentsList = document.getElementById('agentsList');
            const agentItems = agentsList.getElementsByClassName('agent-item');
            const adminSelect = document.getElementById('adminAgentSelect');
            
            // Parcourir tous les éléments d'agent pour trouver celui qui correspond
            for (let item of agentItems) {
                const emailElement = item.querySelector('.agent-email');
                if (emailElement) {
                    const agentEmail = getAgentEmailById(agentId);
                    
                    if (agentEmail && emailElement.textContent === agentEmail) {
                        // Mettre à jour le badge de statut
                        const statusBadge = item.querySelector('.status-badge');
                        if (statusBadge) {
                            let statusClass, displayStatus;
                            
                            if (isConnectionUpdate) {
                                // C'est une mise à jour de connexion/déconnexion
                                if (newStatus === 'connecté') {
                                    statusClass = 'connected';
                                    const now = new Date();
                                    displayStatus = `Connecté (${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})})`;
                                } else {
                                    statusClass = 'disconnected';
                                    const now = new Date();
                                    displayStatus = `Déconnecté (${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})})`;
                                }
                            } else {
                                // C'est un changement de statut normal
                                statusClass = getStatusClass(newStatus);
                                displayStatus = newStatus;
                            }
                            
                            statusBadge.className = `status-badge ${statusClass}`;
                            statusBadge.textContent = displayStatus;
                        }
                        break;
                    }
                }
            }
            
            // Mettre à jour aussi la liste déroulante admin
            updateSelectOption(agentId, newStatus, isConnectionUpdate);
        }

        // METTRE À JOUR L'OPTION DANS LA LISTE DÉROULANTE ADMIN + GESTION DÉCONNEXION
        function updateSelectOption(agentId, newStatus, isConnectionUpdate = false) {
            const adminSelect = document.getElementById('adminAgentSelect');
            const options = adminSelect.getElementsByTagName('option');
            
            // Si l'agent se déconnecte, le retirer de la liste déroulante admin
            if ((isConnectionUpdate && newStatus === 'déconnecté') || 
                (!isConnectionUpdate && newStatus === 'Déconnecté')) {
                
                for (let i = options.length - 1; i >= 0; i--) {
                    if (options[i].value === agentId) {
                        adminSelect.removeChild(options[i]);
                        break;
                    }
                }
                // Réinitialiser la sélection
                adminSelect.value = '';
                
                // Si plus d'agents dans la liste, afficher un message
                if (adminSelect.options.length === 1) { // seulement l'option par défaut
                    adminSelect.innerHTML = '<option value="">Aucun agent connecté actuellement</option>';
                }
            } else if (isConnectionUpdate && newStatus === 'connecté') {
                // Si l'agent se connecte, l'ajouter à la liste
                const agent = allAgents.find(a => a.id === agentId);
                if (agent && !adminSelect.querySelector(`option[value="${agentId}"]`)) {
                    // Si c'était "Aucun agent connecté", vider la liste d'abord
                    if (adminSelect.innerHTML.includes('Aucun agent connecté')) {
                        adminSelect.innerHTML = '<option value="">Sélectionner un agent par email</option>';
                    }
                    
                    const displayName = (agent.first_name && agent.last_name) 
                        ? `${agent.email} (${agent.first_name} ${agent.last_name})` 
                        : agent.email;
                        
                    const adminOption = document.createElement('option');
                    adminOption.value = agentId;
                    adminOption.textContent = displayName;
                    adminOption.setAttribute('data-status', 'Connecté');
                    adminSelect.appendChild(adminOption);
                }
            } else {
                // Mettre à jour le statut dans l'attribut data-status
                for (let option of options) {
                    if (option.value === agentId) {
                        option.setAttribute('data-status', newStatus);
                        break;
                    }
                }
            }
        }

        // FONCTION DE SECOURS pour forcer la mise à jour
        async function forceConnectionStatusUpdate(statusText, timestamp) {
            try {
                // Méthode alternative avec update direct
                const { data, error } = await supabase
                    .from('shifts')
                    .update({
                        connection_status: statusText,
                        last_connection_update: timestamp.toISOString(),
                        updated_at: timestamp.toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('day_key', dayKey);
                    
                if (error) throw error;
                console.log(`✅ Statut connexion forcé: ${statusText}`);
            } catch (error) {
                console.error('❌ Erreur méthode secours:', error);
            }
        }

        // NOUVELLE FONCTION : Mettre à jour le statut de connexion de l'agent
        async function updateAgentConnectionStatus(status) {
            if (isAdmin) return; // Les admins ne déclenchent pas cette mise à jour
            
            try {
                const now = new Date();
                const statusText = status === 'connecté' ? 'Connecté' : `Déconnecté`;
                
                console.log(`🔄 Mise à jour statut connexion: ${statusText} pour ${currentUser.email}`);
                
                // Mettre à jour dans la table shifts avec FORCE
                const { data, error } = await supabase
                    .from('shifts')
                    .upsert({
                        user_id: currentUser.id,
                        day_key: dayKey,
                        email: currentUser.email,
                        first_name: document.getElementById('firstName').value,
                        last_name: document.getElementById('lastName').value,
                        connection_status: statusText,
                        last_connection_update: now.toISOString(),
                        // FORCER la création si l'agent n'a pas de données aujourd'hui
                        current_status: status === 'connecté' ? null : 'Déconnecté',
                        current_start: status === 'connecté' ? null : now.toISOString(),
                        updated_at: now.toISOString()
                    }, { 
                        onConflict: 'user_id,day_key',
                        ignoreDuplicates: false // FORCER la mise à jour même si existe
                    });
                
                if (error) {
                    console.error('❌ Erreur mise à jour statut connexion:', error);
                    // Essayer une deuxième méthode si la première échoue
                    await forceConnectionStatusUpdate(statusText, now);
                } else {
                    console.log(`✅ Statut connexion mis à jour: ${statusText}`);
                }
                
            } catch (error) {
                console.error('❌ Erreur mise à jour connexion:', error);
            }
        }

        // NOUVELLE FONCTION : Déconnecter complètement un agent (comme s'il avait cliqué lui-même)
        async function forceDisconnectAgent(agentId) {
            let currentScrollPosition;
            
            try {
                console.log('🔄 Déconnexion forcée de l\'agent:', agentId);
                
                // Sauvegarder la position de scroll actuelle
                currentScrollPosition = window.scrollY || document.documentElement.scrollTop;
                
                const userEmail = getAgentEmailById(agentId);
                const fullName = getAgentFullName(agentId);
                
                console.log('👤 Agent à déconnecter:', userEmail);
                
                // 1. Mettre à jour le statut de connexion à "Déconnecté"
                const now = new Date();
                const { data, error } = await supabase
                    .from('shifts')
                    .upsert({
                        user_id: agentId,
                        day_key: dayKey,
                        email: userEmail,
                        first_name: fullName.split(' ')[0] || '',
                        last_name: fullName.split(' ').slice(1).join(' ') || '',
                        connection_status: 'Déconnecté',
                        last_connection_update: now.toISOString(),
                        current_status: 'Déconnecté',
                        current_start: null,
                        updated_at: now.toISOString()
                    }, { 
                        onConflict: 'user_id,day_key'
                    });
                
                if (error) throw error;
                
                console.log('✅ Agent déconnecté avec succès');
                
                // 2. Mettre à jour l'interface admin
                const adminStatus = document.getElementById('adminStatus');
                adminStatus.style.display = 'block';
                adminStatus.textContent = `✅ ${userEmail} a été déconnecté avec succès`;
                adminStatus.className = 'sync-status success';
                
                // 3. Mettre à jour l'affichage (retirer de la liste déroulante)
                updateSingleAgentInList(agentId, 'déconnecté', true);
                
                // 4. Restaurer la position du scroll
                setTimeout(() => {
                    window.scrollTo(0, currentScrollPosition);
                }, 10);
                
                setTimeout(() => {
                    adminStatus.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('❌ Erreur déconnexion forcée:', error);
                const adminStatus = document.getElementById('adminStatus');
                adminStatus.style.display = 'block';
                adminStatus.textContent = '❌ Erreur lors de la déconnexion: ' + error.message;
                adminStatus.className = 'sync-status error';
                
                if (currentScrollPosition !== undefined) {
                    setTimeout(() => {
                        window.scrollTo(0, currentScrollPosition);
                    }, 10);
                }
                
                setTimeout(() => {
                    adminStatus.style.display = 'none';
                }, 3000);
            }
        }

        async function setAgentStatus(agentId, status) {
            let currentScrollPosition;
            
            try {
                console.log('🔄 Forçage du statut:', agentId, status);
                
                // Sauvegarder la position de scroll actuelle AVANT toute opération
                currentScrollPosition = window.scrollY || document.documentElement.scrollTop;
                
                // VÉRIFIER SI L'AGENT EST ACTUELLEMENT CONNECTÉ
                const { data: currentData, error: checkError } = await supabase
                    .from('shifts')
                    .select('current_status, connection_status')
                    .eq('user_id', agentId)
                    .eq('day_key', dayKey)
                    .single();

                if (checkError || !currentData) {
                    throw new Error('Impossible de modifier le statut d\'un agent non connecté aujourd\'hui');
                }

                // VÉRIFICATION RENFORCÉE : Empêcher TOUT changement de statut pour les agents déconnectés
                if (currentData.connection_status === 'Déconnecté') {
                    throw new Error('Impossible de modifier le statut d\'un agent déconnecté. Vous pouvez seulement le forcer à se déconnecter.');
                }
                
                const userEmail = getAgentEmailById(agentId);
                const fullName = getAgentFullName(agentId);
                
                console.log('👤 Utilisateur trouvé:', userEmail);
                
                // Mettre à jour dans shifts
                const { data, error } = await supabase
                    .from('shifts')
                    .upsert({
                        user_id: agentId,
                        day_key: dayKey,
                        email: userEmail,
                        first_name: fullName.split(' ')[0] || '',
                        last_name: fullName.split(' ').slice(1).join(' ') || '',
                        current_status: status,
                        current_start: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }, { 
                        onConflict: 'user_id,day_key'
                    });
                
                if (error) throw error;
                
                console.log('✅ Statut forcé avec succès');
                
                // Afficher le succès
                const adminStatus = document.getElementById('adminStatus');
                adminStatus.style.display = 'block';
                adminStatus.textContent = `✅ Statut "${status}" appliqué à ${userEmail}`;
                adminStatus.className = 'sync-status success';
                
                // OPTIMISATION: Mettre à jour seulement l'élément modifié au lieu de recharger toute la liste
                updateSingleAgentInList(agentId, status);
                
                // Restaurer immédiatement la position du scroll (plus fluide)
                setTimeout(() => {
                    window.scrollTo(0, currentScrollPosition);
                }, 10);
                
                setTimeout(() => {
                    adminStatus.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('❌ Erreur mise à jour statut:', error);
                const adminStatus = document.getElementById('adminStatus');
                adminStatus.style.display = 'block';
                adminStatus.textContent = '❌ ' + error.message;
                adminStatus.className = 'sync-status error';
                
                // Restaurer le scroll en cas d'erreur
                if (currentScrollPosition !== undefined) {
                    setTimeout(() => {
                        window.scrollTo(0, currentScrollPosition);
                    }, 10);
                }
                
                setTimeout(() => {
                    adminStatus.style.display = 'none';
                }, 3000);
            }
        }

        // ==================== RÉINITIALISATION DES TOTAUX ADMIN ====================

        async function resetAdminTotals() {
            if (!isAdmin) {
                alert('Accès réservé aux administrateurs');
                return;
            }
            
            const confirmation = confirm(
                '🔄 RÉINITIALISATION DES TOTAUX\n\n' +
                'Vous êtes sur le point de réinitialiser vos totaux actuels.\n\n' +
                'Cette action :\n' +
                '• Remettra à zéro vos compteurs de temps\n' +
                '• Conservera vos données historiques sur Supabase\n' +
                '• N\'affectera pas les autres agents\n\n' +
                'Confirmer la réinitialisation ?'
            );
            
            if (!confirmation) {
                return;
            }
            
            try {
                // Réinitialiser les totaux locaux
                totals = {'En prod':0,'Pause':0,'Formation':0,'Brief':0,'Déconnecté':0};
                current = null;
                
                // Mettre à jour l'interface
                updateTotalsUI();
                updateStatusDisplay();
                updateButtonsAppearance(null);
                
                // Sauvegarder les changements locaux
                saveToLocalStorage();
                
                // Mettre à jour Supabase avec des totaux à zéro
                const dataToSave = {
                    user_id: currentUser.id,
                    day_key: dayKey,
                    email: currentUser.email,
                    first_name: document.getElementById('firstName').value,
                    last_name: document.getElementById('lastName').value,
                    en_prod: 0,
                    pause: 0,
                    formation: 0,
                    brief: 0,
                    deconnecte: 0,
                    current_status: null,
                    current_start: null,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('shifts')
                    .upsert(dataToSave, { onConflict: 'user_id,day_key' });

                if (error) throw error;
                
                // Afficher le succès
                const adminStatus = document.getElementById('adminStatus');
                adminStatus.style.display = 'block';
                adminStatus.textContent = '✅ Vos totaux ont été réinitialisés avec succès';
                adminStatus.className = 'sync-status success';
                
                setTimeout(() => {
                    adminStatus.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('❌ Erreur réinitialisation:', error);
                const adminStatus = document.getElementById('adminStatus');
                adminStatus.style.display = 'block';
                adminStatus.textContent = '❌ Erreur lors de la réinitialisation: ' + error.message;
                adminStatus.className = 'sync-status error';
                
                setTimeout(() => {
                    adminStatus.style.display = 'none';
                }, 3000);
            }
        }

        function setupRealtimeSubscription() {
            if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
            }
            
            realtimeSubscription = supabase
                .channel('shifts-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'shifts',
                        filter: `day_key=eq.${dayKey}`
                    }, 
                    (payload) => {
                        console.log('🔄 Changement en temps réel détecté:', payload);
                        
                        if (isAdmin) {
                            // Si c'est un admin, mettre à jour l'affichage des agents
                            if (payload.new && payload.eventType !== 'DELETE') {
                                // Vérifier si c'est une mise à jour de connexion
                                const isConnectionUpdate = payload.new.connection_status !== undefined;
                                
                                if (isConnectionUpdate) {
                                    console.log('📡 Mise à jour connexion détectée:', payload.new.connection_status);
                                    const status = payload.new.connection_status.includes('Connecté') ? 'connecté' : 'déconnecté';
                                    updateSingleAgentInList(payload.new.user_id, status, true);
                                    
                                    // Recharger aussi la liste déroulante
                                    setTimeout(() => {
                                        loadAgentsForAdmin();
                                    }, 500);
                                } else if (payload.new.current_status) {
                                    // Mettre à jour seulement l'agent modifié (optimisation)
                                    updateSingleAgentInList(payload.new.user_id, payload.new.current_status);
                                }
                            } else {
                                // Recharger toute la liste si suppression ou autre événement
                                loadAgentsForAdmin();
                            }
                        }
                        
                        // Mettre à jour le statut de l'utilisateur courant si nécessaire
                        if (payload.new && payload.new.user_id === currentUser?.id) {
                            if (payload.new.current_status && payload.new.current_status !== current?.status) {
                                console.log('🔄 Mise à jour du statut local:', payload.new.current_status);
                                setStatus(payload.new.current_status);
                            }
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('📡 Statut subscription:', status);
                });
        }

        // ==================== CONNEXION ====================

        async function checkExistingSession() {
            try {
                const localSession = loadCurrentSession();
                
                if (localSession) {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    if (error) throw error;
                    
                    if (session?.user?.id === localSession.user.id) {
                        currentUser = session.user;
                        isAdmin = localSession.isAdmin;
                        
                        document.getElementById('firstName').value = currentUser.user_metadata?.first_name || '';
                        document.getElementById('lastName').value = currentUser.user_metadata?.last_name || '';
                        document.getElementById('email').value = currentUser.email || '';
                        
                        await onLogin();
                        return;
                    } else {
                        clearCurrentSession();
                    }
                }
                
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;
                
                if (session?.user) {
                    currentUser = session.user;
                    isAdmin = currentUser.email === 'khyi.ahmed1@gmail.com';
                    
                    saveCurrentSession();
                    
                    const userMetadata = currentUser.user_metadata;
                    document.getElementById('firstName').value = userMetadata?.first_name || '';
                    document.getElementById('lastName').value = userMetadata?.last_name || '';
                    document.getElementById('email').value = currentUser.email || '';
                    
                    await onLogin();
                } else {
                    document.getElementById('syncStatus').textContent = 'Prêt à se connecter';
                    document.getElementById('loginView').style.display = 'block';
                    document.getElementById('appView').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('syncStatus').textContent = 'Prêt à se connecter';
                document.getElementById('loginView').style.display = 'block';
                document.getElementById('appView').style.display = 'none';
            }
        }

        async function handleLogin() {
            const elements = {
                firstName: document.getElementById('firstName'),
                lastName: document.getElementById('lastName'),
                email: document.getElementById('email'),
                password: document.getElementById('password'),
                loginError: document.getElementById('loginError'),
                syncStatus: document.getElementById('syncStatus')
            };

            const email = elements.email.value.trim();
            const password = elements.password.value.trim();
            const firstName = elements.firstName.value.trim();
            const lastName = elements.lastName.value.trim();

            if(!email || !password || !firstName || !lastName){
                elements.loginError.style.display = 'block';
                elements.loginError.textContent = 'Veuillez remplir tous les champs';
                return;
            }

            try {
                console.log('🔐 Tentative de connexion:', email);
                elements.loginError.style.display = 'none';
                elements.syncStatus.textContent = 'Connexion en cours...';

                isAdmin = email === 'khyi.ahmed1@gmail.com';

                // Essayer de se connecter
                const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (signInError) {
                    // Si échec, créer un nouveau compte
                    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                first_name: firstName,
                                last_name: lastName
                            }
                        }
                    });

                    if (signUpError) throw signUpError;
                    
                    currentUser = signUpData.user;
                    
                    saveCurrentSession();
                    
                    elements.syncStatus.textContent = 'Compte créé ! Redirection...';
                    setTimeout(async () => {
                        await onLogin();
                    }, 2000);
                } else {
                    currentUser = signInData.user;
                    saveCurrentSession();
                    
                    elements.syncStatus.textContent = 'Connexion réussie !';
                    await onLogin();
                }
                
            } catch (error) {
                console.error('❌ Erreur connexion:', error);
                elements.loginError.style.display = 'block';
                elements.loginError.textContent = 'Erreur: ' + error.message;
                elements.syncStatus.textContent = 'Erreur de connexion';
            }
        }

        async function onLogin(){
            // Nettoyer l'historique ancien
            clearOldHistory();
            
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('appView').style.display = 'block';
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            document.getElementById('agentName').textContent = `${firstName} ${lastName}`;
            
            console.log('🔐 Utilisateur connecté:', currentUser.email);
            console.log('👑 Est admin:', isAdmin);
            
            if (isAdmin) {
                document.getElementById('agentRole').textContent = 'Administrateur';
                document.getElementById('exportSection').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'block';
                console.log('🚀 Panel admin activé');
                
                // Charger tous les agents pour l'export
                await loadAllAgents();
                console.log('🏁 Connexion admin terminée, chargement des agents...');
            } else {
                document.getElementById('agentRole').textContent = 'Suivi en temps réel';
                document.getElementById('exportSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'none';
                
                // CORRECTION : Attendre que la connexion soit bien enregistrée
                console.log('👤 Agent connecté - Mise à jour du statut...');
                await updateAgentConnectionStatus('connecté');
                
                // Attendre un peu pour que Supabase synchronise
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Appliquer les restrictions horaires pour les agents
                updateAccessBasedOnTime();
                console.log('🏁 Connexion agent terminée, statut mis à jour');
            }
            
            dayKey = todayKey();
            startClock();
            
            loadFromLocalStorage();
            await loadDataFromSupabase();
            
            startAutoSave();
            setupRealtimeSubscription();
            
            // Vérifier périodiquement les horaires
            setInterval(updateAccessBasedOnTime, 60000);
            
            if (isAdmin) {
                // Recharger périodiquement la liste des agents
                setInterval(loadAgentsForAdmin, 30000);
                
                // FORCER le rechargement immédiat après un délai
                setTimeout(() => {
                    loadAgentsForAdmin();
                    console.log('🔄 Rechargement forcé de la liste admin');
                }, 2000);
            }
        }

        // ==================== DONNÉES SUPABASE ====================

        async function loadDataFromSupabase(){
            const appSyncStatus = document.getElementById('appSyncStatus');
            
            try {
                appSyncStatus.textContent = 'Chargement des données...';
                
                const { data, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('day_key', dayKey)
                    .maybeSingle();

                if (error) throw error;

                if (data) {
                    totals = {
                        'En prod': minToSec(data.en_prod || 0),
                        'Pause': minToSec(data.pause || 0),
                        'Formation': minToSec(data.formation || 0),
                        'Brief': minToSec(data.brief || 0),
                        'Déconnecté': minToSec(data.deconnecte || 0)
                    };
                    
                    if (data.current_status && data.current_start) {
                        current = { 
                            status: data.current_status, 
                            start: new Date(data.current_start) 
                        };
                        updateButtonsAppearance(data.current_status);
                    }
                    
                    appSyncStatus.textContent = 'Données synchronisées';
                } else {
                    if (!loadFromLocalStorage()) {
                        totals = {'En prod':0,'Pause':0,'Formation':0,'Brief':0,'Déconnecté':0};
                        current = null;
                    }
                    await saveToSupabase();
                    appSyncStatus.textContent = 'Nouvelle session démarrée';
                }

                updateStatusDisplay();
                updateTotalsUI();
                startElapsedLoop();
                
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                appSyncStatus.textContent = 'Erreur chargement - Mode local';
                updateStatusDisplay();
                updateTotalsUI();
                startElapsedLoop();
            }
        }

        async function saveToSupabase() {
            const appSyncStatus = document.getElementById('appSyncStatus');
            
            try {
                let currentSeconds = 0;
                if (current) {
                    currentSeconds = Math.floor((Date.now() - current.start.getTime()) / 1000);
                }
                
                const dataToSave = {
                    user_id: currentUser.id,
                    day_key: dayKey,
                    email: currentUser.email,
                    first_name: document.getElementById('firstName').value,
                    last_name: document.getElementById('lastName').value,
                    en_prod: secToMin(totals['En prod'] + (current?.status === 'En prod' ? currentSeconds : 0)),
                    pause: secToMin(totals['Pause'] + (current?.status === 'Pause' ? currentSeconds : 0)),
                    formation: secToMin(totals['Formation'] + (current?.status === 'Formation' ? currentSeconds : 0)),
                    brief: secToMin(totals['Brief'] + (current?.status === 'Brief' ? currentSeconds : 0)),
                    deconnecte: secToMin(totals['Déconnecté'] + (current?.status === 'Déconnecté' ? currentSeconds : 0)),
                    current_status: current ? current.status : null,
                    current_start: current ? current.start.toISOString() : null,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('shifts')
                    .upsert(dataToSave, { onConflict: 'user_id,day_key' });

                if (error) throw error;

                appSyncStatus.textContent = 'Sauvegardé: ' + new Date().toLocaleTimeString();
                appSyncStatus.className = 'sync-status success';
                
            } catch (error) {
                console.error('❌ Erreur sauvegarde:', error);
                appSyncStatus.textContent = 'Erreur sauvegarde: ' + error.message;
                appSyncStatus.className = 'sync-status error';
            }
        }

        // ==================== DÉCONNEXION ====================

        async function handleLogout(){
            const answer = confirm("Voulez-vous vraiment vous déconnecter ?");
            if(!answer) return;
            
            // POUR LES AGENTS : Mettre à jour le statut avant de déconnecter
            if (!isAdmin && currentUser) {
                await updateAgentConnectionStatus('déconnecté');
            }
            
            // ARRÊTER LE COMPTEUR IMMÉDIATEMENT
            if(current) {
                const endTime = new Date();
                const secondsSpent = Math.floor((endTime - current.start.getTime()) / 1000);
                totals[current.status] += secondsSpent;
                
                // Sauvegarder dans l'historique avant de déconnecter
                saveToHistory(current.status, current.start, endTime, secondsSpent);
                current = null; // Arrêter immédiatement le compteur
                
                // Sauvegarder les données
                await saveToSupabase();
            }
            
            // Arrêter tous les timers
            if(elapsedTimer) clearInterval(elapsedTimer);
            if(clockTimer) clearInterval(clockTimer);
            if(autoSaveInterval) clearInterval(autoSaveInterval);
            
            await supabase.auth.signOut();
            
            if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
            }
            
            clearCurrentSession();
            
            document.getElementById('loginView').style.display = 'block';
            document.getElementById('appView').style.display = 'none';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('syncStatus').textContent = 'Déconnecté avec succès';
            
            current = null;
            currentUser = null;
            isAdmin = false;
            totals = {'En prod':0,'Pause':0,'Formation':0,'Brief':0,'Déconnecté':0};
            
            document.body.classList.remove('status-prod', 'status-pause', 'status-formation', 'status-brief', 'status-deco');
        }

        // ==================== GESTION DE L'EXPORT ====================

        function setupExportControls() {
            const exportType = document.getElementById('exportType');
            const dailyContainer = document.getElementById('dailyDateContainer');
            const monthlyContainer = document.getElementById('monthlyDateContainer');
            const rangeContainer = document.getElementById('dateRangeContainer');
            
            // Initialiser les dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('exportDailyDate').value = today;
            document.getElementById('exportMonth').value = new Date().toISOString().slice(0, 7);
            document.getElementById('exportStartDate').value = today;
            document.getElementById('exportEndDate').value = today;
            
            exportType.addEventListener('change', function() {
                const type = this.value;
                
                // Masquer tous les conteneurs
                dailyContainer.style.display = 'none';
                monthlyContainer.style.display = 'none';
                rangeContainer.style.display = 'none';
                
                // Afficher le conteneur approprié
                if (type === 'daily') {
                    dailyContainer.style.display = 'block';
                } else if (type === 'monthly') {
                    monthlyContainer.style.display = 'block';
                } else if (type === 'range') {
                    rangeContainer.style.display = 'flex';
                }
            });
            
            // Déclencher l'événement change pour initialiser l'affichage
            exportType.dispatchEvent(new Event('change'));
        }

        // ==================== EXPORT AVEC FALLBACK SUPABASE ====================

        async function exportAgentData() {
            const exportBtn = document.getElementById('exportBtn');
            const exportStatus = document.getElementById('exportStatus');
            const agentSelect = document.getElementById('exportAgentSelect');
            const exportType = document.getElementById('exportType').value;
            
            const selectedAgentId = agentSelect.value;
            
            if (!selectedAgentId) {
                alert('Veuillez sélectionner un agent ou l\'option d\'extraction groupée');
                return;
            }
            
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
                exportStatus.style.display = 'block';
                exportStatus.textContent = 'Export depuis l\'historique local...';
                exportStatus.className = 'sync-status';

                let startDate, endDate, periodDescription, fileName;

                // Déterminer les dates selon le type d'export
                if (exportType === 'daily') {
                    const selectedDate = document.getElementById('exportDailyDate').value;
                    startDate = selectedDate;
                    endDate = selectedDate;
                    periodDescription = `Journée du ${formatDateForExcel(selectedDate)}`;
                    fileName = selectedAgentId === 'all' 
                        ? `Rapport_Groupé_${selectedDate}.csv` 
                        : `Rapport_${getAgentEmailById(selectedAgentId)}_${selectedDate}.csv`;
                } 
                else if (exportType === 'monthly') {
                    const selectedMonth = document.getElementById('exportMonth').value;
                    const [year, month] = selectedMonth.split('-');
                    startDate = `${year}-${month}-01`;
                    endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;
                    periodDescription = `Mois de ${getFrenchMonthName(selectedMonth)} ${year}`;
                    fileName = selectedAgentId === 'all'
                        ? `Rapport_Groupé_${selectedMonth}.csv`
                        : `Rapport_${getAgentEmailById(selectedAgentId)}_${selectedMonth}.csv`;
                } 
                else if (exportType === 'range') {
                    startDate = document.getElementById('exportStartDate').value;
                    endDate = document.getElementById('exportEndDate').value;
                    
                    if (!startDate || !endDate) {
                        throw new Error('Veuillez sélectionner une date de début et une date de fin');
                    }
                    
                    if (startDate > endDate) {
                        throw new Error('La date de début doit être antérieure à la date de fin');
                    }
                    
                    periodDescription = `Période du ${formatDateForExcel(startDate)} au ${formatDateForExcel(endDate)}`;
                    fileName = selectedAgentId === 'all'
                        ? `Rapport_Groupé_${startDate}_a_${endDate}.csv`
                        : `Rapport_${getAgentEmailById(selectedAgentId)}_${startDate}_a_${endDate}.csv`;
                }

                let csv;
                
                // Vérifier d'abord si on a des données dans l'historique local
                const localHistory = loadHistory();
                const hasLocalData = localHistory.some(entry => 
                    entry.date >= startDate && entry.date <= endDate
                );

                if (hasLocalData) {
                    // Utiliser l'historique local
                    if (selectedAgentId === 'all') {
                        csv = await exportAllAgentsFromHistory(startDate, endDate, periodDescription);
                    } else {
                        csv = await exportSingleAgentFromHistory(selectedAgentId, startDate, endDate, periodDescription);
                    }
                    exportStatus.textContent = '✅ Rapport généré depuis l\'historique local !';
                } else {
                    // Fallback: Utiliser Supabase
                    exportStatus.textContent = '📡 Données locales manquantes, utilisation de Supabase...';
                    
                    if (selectedAgentId === 'all') {
                        csv = await exportAllAgentsFromSupabase(startDate, endDate, periodDescription);
                    } else {
                        csv = await exportSingleAgentFromSupabase(selectedAgentId, startDate, endDate, periodDescription);
                    }
                    exportStatus.textContent = '✅ Rapport généré depuis Supabase !';
                }

                downloadCSV(csv, fileName);
                exportStatus.className = 'sync-status success';
                
            } catch (error) {
                console.error('Erreur export:', error);
                exportStatus.textContent = '❌ Erreur: ' + error.message;
                exportStatus.className = 'sync-status error';
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i class="fas fa-file-export"></i> Exporter les données';
            }
        }

        async function exportSingleAgentFromHistory(agentId, startDate, endDate, periodDescription) {
            const agentEmail = getAgentEmailById(agentId);
            const agentName = getAgentFullName(agentId);

            // Charger l'historique local
            const history = loadHistory();
            
            // Filtrer pour cet agent et cette période
            const filteredHistory = history.filter(entry => 
                entry.userEmail === agentEmail && 
                entry.date >= startDate && 
                entry.date <= endDate
            );

            if (filteredHistory.length === 0) {
                throw new Error('Aucune donnée historique trouvée pour cet agent sur cette période');
            }

            return convertHistoryToExcel(filteredHistory, agentEmail, agentName, startDate, endDate, periodDescription, false);
        }

        async function exportAllAgentsFromHistory(startDate, endDate, periodDescription) {
            // Charger l'historique local
            const history = loadHistory();
            
            // Filtrer pour la période
            const filteredHistory = history.filter(entry => 
                entry.date >= startDate && 
                entry.date <= endDate
            );

            if (filteredHistory.length === 0) {
                throw new Error('Aucune donnée historique trouvée pour cette période');
            }

            return convertHistoryToExcel(filteredHistory, 'extraction.groupée@gmail.com', 'Extraction Groupée', startDate, endDate, periodDescription, true);
        }

        async function exportSingleAgentFromSupabase(agentId, startDate, endDate, periodDescription) {
            const agentEmail = getAgentEmailById(agentId);
            const agentName = getAgentFullName(agentId);

            // Récupérer les données depuis Supabase
            const { data, error } = await supabase
                .from('shifts')
                .select('*')
                .eq('user_id', agentId)
                .gte('day_key', startDate)
                .lte('day_key', endDate)
                .order('day_key', { ascending: true });

            if (error) throw error;
            if (!data || data.length === 0) {
                throw new Error('Aucune donnée trouvée pour cet agent sur cette période');
            }

            return convertSupabaseDataToExcel(data, agentEmail, agentName, startDate, endDate, periodDescription, false);
        }

        async function exportAllAgentsFromSupabase(startDate, endDate, periodDescription) {
            // Récupérer les données depuis Supabase
            const { data, error } = await supabase
                .from('shifts')
                .select('*')
                .gte('day_key', startDate)
                .lte('day_key', endDate)
                .order('user_id')
                .order('day_key', { ascending: true });

            if (error) throw error;
            if (!data || data.length === 0) {
                throw new Error('Aucune donnée trouvée pour cette période');
            }

            return convertSupabaseDataToExcel(data, 'extraction.groupée@gmail.com', 'Extraction Groupée', startDate, endDate, periodDescription, true);
        }

        function convertHistoryToExcel(history, agentEmail, agentName, startDate, endDate, periodDescription, isGrouped) {
            // En-têtes sans "Statut Final"
            const headers = [
                'Email Agent',
                'Nom Complet',
                'Date',
                'Jour de la semaine', 
                'Statut',
                'Heure de début',
                'Heure de fin',
                'Durée (heures)'
            ];

            // Organiser les données par date et statut
            const organizedData = {};
            
            history.forEach(entry => {
                const dateKey = entry.date;
                if (!organizedData[dateKey]) {
                    organizedData[dateKey] = {};
                }
                
                if (!organizedData[dateKey][entry.status]) {
                    organizedData[dateKey][entry.status] = {
                        totalDuration: 0,
                        periods: []
                    };
                }
                
                organizedData[dateKey][entry.status].totalDuration += entry.duration;
                organizedData[dateKey][entry.status].periods.push({
                    start: entry.start,
                    end: entry.end,
                    userEmail: entry.userEmail,
                    userName: agentName
                });
            });

            const csvRows = [];
            
            // Pour chaque date de la période
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dateStr = date.toISOString().split('T')[0];
                const dayData = organizedData[dateStr] || {};
                
                // Pour chaque statut cette journée
                const statuses = ['En prod', 'Pause', 'Formation', 'Brief', 'Déconnecté'];
                
                statuses.forEach(status => {
                    const statusData = dayData[status];
                    if (statusData && statusData.totalDuration > 0) {
                        const firstPeriod = statusData.periods[0];
                        const lastPeriod = statusData.periods[statusData.periods.length - 1];
                        
                        const row = [
                            isGrouped ? firstPeriod.userEmail : agentEmail,
                            isGrouped ? firstPeriod.userName : agentName,
                            formatDateForExcel(dateStr),
                            getFrenchDayName(dateStr),
                            status,
                            formatTimeForExcel(new Date(firstPeriod.start)),
                            formatTimeForExcel(new Date(lastPeriod.end)),
                            formatSecondsToDecimal(statusData.totalDuration)
                        ];
                        
                        csvRows.push(row.join(';'));
                    }
                });
            }

            // En-tête informatif
            const infoHeaders = [
                [`RAPPORT MY SHIFT - ${periodDescription}`, '', '', '', '', '', '', ''],
                [`Email: ${agentEmail}`, '', '', '', '', '', '', ''],
                [`Période: Du ${formatDateForExcel(startDate)} au ${formatDateForExcel(endDate)}`, '', '', '', '', '', '', ''],
                [`Généré le: ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', '']
            ];

            const allRows = [
                ...infoHeaders.map(row => row.join(';')),
                headers.join(';'),
                ...csvRows
            ];
            
            return allRows.join('\n');
        }

        function convertSupabaseDataToExcel(data, agentEmail, agentName, startDate, endDate, periodDescription, isGrouped) {
            // En-têtes pour les données Supabase
            const headers = [
                'Email Agent',
                'Nom Complet',
                'Date',
                'Jour de la semaine', 
                'Production (heures)',
                'Pause (heures)',
                'Formation (heures)',
                'Briefing (heures)',
                'Déconnecté (heures)',
                'Total (heures)'
            ];

            const csvRows = [];
            
            // Organiser les données par utilisateur et date
            const usersData = {};
            
            data.forEach(row => {
                if (!usersData[row.user_id]) {
                    usersData[row.user_id] = {
                        email: row.email,
                        name: `${row.first_name || ''} ${row.last_name || ''}`.trim() || 'Nom non renseigné',
                        days: new Map()
                    };
                }
                
                usersData[row.user_id].days.set(row.day_key, {
                    date: row.day_key,
                    prod: parseInt(row.en_prod) || 0,
                    pause: parseInt(row.pause) || 0,
                    formation: parseInt(row.formation) || 0,
                    brief: parseInt(row.brief) || 0,
                    deco: parseInt(row.deconnecte) || 0
                });
            });
            
            // Pour chaque date de la période
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dateStr = date.toISOString().split('T')[0];
                
                Object.values(usersData).forEach(user => {
                    const dayData = user.days.get(dateStr) || {
                        date: dateStr,
                        prod: 0,
                        pause: 0,
                        formation: 0,
                        brief: 0,
                        deco: 0
                    };
                    
                    const totalDay = dayData.prod + dayData.pause + dayData.formation + dayData.brief + dayData.deco;
                    
                    const row = [
                        user.email,
                        user.name,
                        formatDateForExcel(dateStr),
                        getFrenchDayName(dateStr),
                        formatMinutesToDecimal(dayData.prod),
                        formatMinutesToDecimal(dayData.pause),
                        formatMinutesToDecimal(dayData.formation),
                        formatMinutesToDecimal(dayData.brief),
                        formatMinutesToDecimal(dayData.deco),
                        formatMinutesToDecimal(totalDay)
                    ];
                    
                    csvRows.push(row.join(';'));
                });
            }

            // En-tête informatif
            const infoHeaders = [
                [`RAPPORT MY SHIFT - ${periodDescription}`, '', '', '', '', '', '', '', '', ''],
                [`Email: ${agentEmail}`, '', '', '', '', '', '', '', '', ''],
                [`Période: Du ${formatDateForExcel(startDate)} au ${formatDateForExcel(endDate)}`, '', '', '', '', '', '', '', '', ''],
                [`Généré le: ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, '', '', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', '', '', '']
            ];

            const allRows = [
                ...infoHeaders.map(row => row.join(';')),
                headers.join(';'),
                ...csvRows
            ];
            
            return allRows.join('\n');
        }

        function formatMinutesToDecimal(minutes) {
            const totalMinutes = parseInt(minutes) || 0;
            const hours = (totalMinutes / 60).toFixed(2);
            return hours.replace('.', ','); // Format français avec virgule
        }

        function formatSecondsToDecimal(seconds) {
            const hours = (seconds / 3600).toFixed(2);
            return hours.replace('.', ',');
        }

        function formatDateForExcel(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR'); // Format JJ/MM/AAAA
        }

        function formatTimeForExcel(date) {
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function getFrenchMonthName(monthString) {
            const [year, month] = monthString.split('-');
            const monthNames = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];
            return monthNames[parseInt(month) - 1];
        }

        function getFrenchDayName(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            return days[date.getDay()];
        }

        function downloadCSV(csv, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ==================== INITIALISATION ====================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 MY SHIFT - Démarrage');
            
            const elements = {
                loginView: document.getElementById('loginView'),
                appView: document.getElementById('appView'),
                firstName: document.getElementById('firstName'),
                lastName: document.getElementById('lastName'),
                email: document.getElementById('email'),
                password: document.getElementById('password'),
                loginBtn: document.getElementById('loginBtn'),
                loginError: document.getElementById('loginError'),
                agentName: document.getElementById('agentName'),
                agentRole: document.getElementById('agentRole'),
                clock: document.getElementById('clock'),
                date: document.getElementById('date'),
                statusText: document.getElementById('statusText'),
                appSyncStatus: document.getElementById('appSyncStatus'),
                btnProd: document.getElementById('btnProd'),
                btnPause: document.getElementById('btnPause'),
                btnFormation: document.getElementById('btnFormation'),
                btnBrief: document.getElementById('btnBrief'),
                btnDeco: document.getElementById('btnDeco'),
                logoutBtn: document.getElementById('logoutBtn'),
                tProd: document.getElementById('tProd'),
                tPause: document.getElementById('tPause'),
                tFormation: document.getElementById('tFormation'),
                tBrief: document.getElementById('tBrief'),
                tDeco: document.getElementById('tDeco'),
                togglePassword: document.getElementById('togglePassword'),
                syncStatus: document.getElementById('syncStatus'),
                exportBtn: document.getElementById('exportBtn'),
                exportStatus: document.getElementById('exportStatus'),
                exportSection: document.getElementById('exportSection'),
                exportAgentSelect: document.getElementById('exportAgentSelect'),
                adminPanel: document.getElementById('adminPanel'),
                adminAgentSelect: document.getElementById('adminAgentSelect'),
                adminStatusSelect: document.getElementById('adminStatusSelect'),
                adminSetStatusBtn: document.getElementById('adminSetStatusBtn'),
                adminDisconnectBtn: document.getElementById('adminDisconnectBtn'),
                adminRefreshBtn: document.getElementById('adminRefreshBtn'),
                adminResetTotalsBtn: document.getElementById('adminResetTotalsBtn'),
                adminStatus: document.getElementById('adminStatus')
            };

            // Initialiser les contrôles d'export
            setupExportControls();

            await checkExistingSession();

            elements.togglePassword.addEventListener('click', function() {
                const isPassword = elements.password.type === 'password';
                elements.password.type = isPassword ? 'text' : 'password';
                this.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
            });

            elements.loginBtn.addEventListener('click', handleLogin);

            elements.btnProd.addEventListener('click', () => setStatus('En prod'));
            elements.btnPause.addEventListener('click', () => setStatus('Pause'));
            elements.btnFormation.addEventListener('click', () => setStatus('Formation'));
            elements.btnBrief.addEventListener('click', () => setStatus('Brief'));
            elements.btnDeco.addEventListener('click', () => setStatus('Déconnecté'));

            elements.exportBtn.addEventListener('click', exportAgentData);
            elements.logoutBtn.addEventListener('click', handleLogout);

            elements.adminSetStatusBtn.addEventListener('click', async () => {
                const agentId = elements.adminAgentSelect.value;
                const status = elements.adminStatusSelect.value;
                
                if (!agentId) {
                    alert('Veuillez sélectionner un agent');
                    return;
                }
                
                await setAgentStatus(agentId, status);
            });
            
            elements.adminDisconnectBtn.addEventListener('click', async () => {
                const agentId = elements.adminAgentSelect.value;
                
                if (!agentId) {
                    alert('Veuillez sélectionner un agent');
                    return;
                }
                
                const confirmation = confirm(`Êtes-vous sûr de vouloir déconnecter ${getAgentEmailById(agentId)} ?\n\nCette action fermera sa session complètement.`);
                
                if (confirmation) {
                    await forceDisconnectAgent(agentId);
                }
            });

            elements.adminRefreshBtn.addEventListener('click', async () => {
                if (isAdmin) {
                    await loadAgentsForAdmin();
                    elements.adminStatus.style.display = 'block';
                    elements.adminStatus.textContent = '✅ Liste actualisée';
                    elements.adminStatus.className = 'sync-status success';
                    setTimeout(() => {
                        elements.adminStatus.style.display = 'none';
                    }, 2000);
                }
            });

            // Nouvel écouteur pour le bouton de réinitialisation
            elements.adminResetTotalsBtn.addEventListener('click', resetAdminTotals);

            [elements.firstName, elements.lastName, elements.email, elements.password].forEach(input => {
                input.addEventListener('keypress', (e) => { 
                    if(e.key === 'Enter') handleLogin(); 
                });
            });
        });
    </script>
</body>
</html>