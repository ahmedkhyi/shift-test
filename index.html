<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MY SHIFT - Suivi Temps R√©el</title>
<style>
/* VARIABLES COULEURS */
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --prod-color: #00b894;
    --pause-color: #fdcb6e;
    --formation-color: #74b9ff;
    --brief-color: #a29bfe;
    --deco-color: #ff7675;
    --bg-prod: linear-gradient(135deg, #e8f8f5, #d1f2eb);
    --bg-pause: linear-gradient(135deg, #fef9e7, #fcf3cf);
    --bg-formation: linear-gradient(135deg, #e8f4fd, #d6eaf8);
    --bg-brief: linear-gradient(135deg, #f4f4ff, #e8e8ff);
    --bg-deco: linear-gradient(135deg, #fdedec, #fadbd8);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    transition: all 0.5s ease;
}

/* Styles pour les diff√©rents fonds selon le statut */
body.status-prod { background: var(--bg-prod); }
body.status-pause { background: var(--bg-pause); }
body.status-formation { background: var(--bg-formation); }
body.status-brief { background: var(--bg-brief); }
body.status-deco { background: var(--bg-deco); }

.container {
    width: 100%;
    max-width: 1200px;
}

/* PAGE DE CONNEXION PROFESSIONNELLE */
.login-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    padding: 50px 40px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    width: 100%;
    max-width: 440px;
    margin: 0 auto;
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.login-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

.login-header {
    text-align: center;
    margin-bottom: 40px;
}

.login-header h1 {
    color: #2d3748;
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 12px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.login-header p {
    color: #718096;
    font-size: 16px;
    font-weight: 500;
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    color: #4a5568;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-group input {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
    background: #f8fafc;
    font-family: inherit;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    background: white;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
}

.password-container {
    position: relative;
}

.toggle-password {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: #718096;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
    font-size: 20px;
}

.toggle-password:hover {
    color: #4a5568;
    background: rgba(0,0,0,0.05);
}

.btn-login {
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
    font-family: inherit;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
}

.btn-login::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-login:hover::before {
    left: 100%;
}

.btn-login:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(102, 126, 234, 0.3);
}

/* APPLICATION PRINCIPALE - DESIGN PROFESSIONNEL */
.app-container {
    display: none;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.app-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 40px 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.app-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
    background-size: cover;
}

.agent-info {
    position: relative;
    z-index: 2;
}

.agent-info h2 {
    font-size: 28px;
    margin-bottom: 12px;
    font-weight: 600;
    opacity: 0.95;
}

.datetime-info {
    margin-top: 20px;
}

#clock {
    font-size: 52px;
    font-weight: 300;
    letter-spacing: 3px;
    margin-bottom: 8px;
    font-feature-settings: "tnum";
    opacity: 0.95;
}

#date {
    font-size: 18px;
    opacity: 0.9;
    font-weight: 500;
}

.app-content {
    padding: 40px;
}

.status-section {
    text-align: center;
    margin-bottom: 40px;
}

.status-indicator {
    background: #f8fafc;
    padding: 30px;
    border-radius: 20px;
    margin-bottom: 30px;
    border: 2px solid #e2e8f0;
    position: relative;
    overflow: hidden;
}

.status-indicator::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 6px;
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

#statusText {
    font-size: 24px;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 8px;
}

#liveInfo {
    color: #718096;
    font-size: 16px;
    font-weight: 500;
}

/* BOUTONS AM√âLIOR√âS */
.buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.btn-status {
    padding: 25px 20px;
    border: none;
    border-radius: 16px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.4s ease;
    font-size: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
    font-family: inherit;
    letter-spacing: 0.5px;
    border: 2px solid transparent;
}

.btn-status span {
    font-size: 28px;
    transition: transform 0.3s ease;
}

.btn-status:hover span {
    transform: scale(1.1);
}

/* √âtats des boutons actifs */
.btn-status.active {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    border: 2px solid white;
}

/* Boutons inactifs */
.btn-status:not(.active) {
    opacity: 0.7;
    filter: grayscale(30%);
    background: linear-gradient(135deg, #a0aec0, #718096) !important;
    color: #edf2f7 !important;
}

/* Couleurs sp√©cifiques pour chaque statut QUAND ACTIF */
.btn-status.prod.active { 
    background: linear-gradient(135deg, var(--prod-color), #00a085);
    box-shadow: 0 15px 30px rgba(0, 184, 148, 0.3);
}

.btn-status.pause.active { 
    background: linear-gradient(135deg, var(--pause-color), #f39c12);
    color: #2d3748;
    box-shadow: 0 15px 30px rgba(253, 203, 110, 0.3);
}

.btn-status.formation.active { 
    background: linear-gradient(135deg, var(--formation-color), #0984e3);
    box-shadow: 0 15px 30px rgba(116, 185, 255, 0.3);
}

.btn-status.brief.active { 
    background: linear-gradient(135deg, var(--brief-color), #6c5ce7);
    box-shadow: 0 15px 30px rgba(162, 155, 254, 0.3);
}

.btn-status.deco.active { 
    background: linear-gradient(135deg, var(--deco-color), #d63031);
    box-shadow: 0 15px 30px rgba(255, 118, 117, 0.3);
}

/* Effet hover pour les boutons inactifs */
.btn-status:not(.active):hover {
    opacity: 0.85;
    transform: translateY(-2px);
    filter: grayscale(15%);
}

/* TOTALS GRID AM√âLIOR√â */
.totals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.total-card {
    background: #f8fafc;
    padding: 25px;
    border-radius: 16px;
    text-align: center;
    border-left: 6px solid;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.total-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: inherit;
    opacity: 0.3;
}

.total-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.total-card.en-prod { border-color: var(--prod-color); }
.total-card.pause { border-color: var(--pause-color); }
.total-card.formation { border-color: var(--formation-color); }
.total-card.brief { border-color: var(--brief-color); }
.total-card.deco { border-color: var(--deco-color); }

.total-card h3 {
    font-size: 14px;
    color: #718096;
    margin-bottom: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.total-card .time {
    font-size: 28px;
    font-weight: 700;
    color: #2d3748;
    font-family: 'Courier New', 'SF Mono', Monaco, monospace;
    letter-spacing: 1px;
}

/* SECTION D√âCONNEXION */
.logout-section {
    text-align: center;
    padding-top: 30px;
    border-top: 2px solid #e2e8f0;
}

.btn-logout {
    padding: 16px 40px;
    background: #718096;
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    letter-spacing: 0.5px;
}

.btn-logout:hover {
    background: #4a5568;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(113, 128, 150, 0.3);
}

/* MESSAGES DE STATUT */
.login-error, .sync-status {
    border-radius: 12px;
    margin-top: 20px;
    text-align: center;
    font-size: 14px;
    font-weight: 500;
}

.login-error {
    background: #fed7d7;
    color: #c53030;
    padding: 16px;
    border: 1px solid #feb2b2;
    display: none;
}

.sync-status {
    background: #e6fffa;
    color: #234e52;
    padding: 12px 16px;
    border: 1px solid #81e6d9;
}

.sync-status.success {
    background: #f0fff4;
    color: #22543d;
    border-color: #9ae6b4;
}

.sync-status.warning {
    background: #fffaf0;
    color: #744210;
    border-color: #faf089;
}

.sync-status.error {
    background: #fff5f5;
    color: #742a2a;
    border-color: #fc8181;
}
</style>
</head>
<body>
    <div class="container">
        <div class="login-card" id="loginView">
            <div class="login-header">
                <h1>MY SHIFT</h1>
                <p>Connectez-vous pour d√©marrer le suivi</p>
            </div>
            <div class="form-group">
                <label for="firstName">Pr√©nom</label>
                <input type="text" id="firstName" placeholder="Votre pr√©nom">
            </div>
            <div class="form-group">
                <label for="lastName">Nom</label>
                <input type="text" id="lastName" placeholder="Votre nom">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="votre@email.com">
            </div>
            <div class="form-group">
                <label for="password">Mot de passe</label>
                <div class="password-container">
                    <input type="password" id="password" placeholder="Votre mot de passe">
                    <button type="button" class="toggle-password" id="togglePassword">üëÅÔ∏è</button>
                </div>
            </div>
            <button class="btn-login" id="loginBtn">Se connecter</button>
            <div class="login-error" id="loginError"></div>
            <div class="sync-status" id="syncStatus">Chargement de Supabase...</div>
        </div>

        <div class="app-container" id="appView">
            <div class="app-header">
                <div class="agent-info">
                    <h2 id="agentName">Agent</h2>
                    <div class="datetime-info">
                        <div id="clock">--:--:--</div>
                        <div id="date">-- -- ----</div>
                    </div>
                </div>
            </div>
            
            <div class="app-content">
                <div class="status-section">
                    <div class="status-indicator">
                        <div id="statusText">Aucun statut s√©lectionn√©</div>
                        <div id="liveInfo">Choisissez un statut pour d√©marrer</div>
                        <div class="sync-status" id="appSyncStatus"></div>
                    </div>
                    
                    <div class="buttons-grid">
                        <button class="btn-status prod" id="btnProd" data-status="En prod">
                            <span>üéØ</span>
                            En production
                        </button>
                        <button class="btn-status pause" id="btnPause" data-status="Pause">
                            <span>‚òï</span>
                            Pause
                        </button>
                        <button class="btn-status formation" id="btnFormation" data-status="Formation">
                            <span>üìö</span>
                            Formation
                        </button>
                        <button class="btn-status brief" id="btnBrief" data-status="Brief">
                            <span>üí¨</span>
                            Briefing
                        </button>
                        <button class="btn-status deco" id="btnDeco" data-status="D√©connect√©">
                            <span>üö™</span>
                            D√©connect√©
                        </button>
                    </div>
                </div>

                <div class="totals-grid">
                    <div class="total-card en-prod">
                        <h3>Production</h3>
                        <div class="time" id="tProd">00:00:00</div>
                    </div>
                    <div class="total-card pause">
                        <h3>Pause</h3>
                        <div class="time" id="tPause">00:00:00</div>
                    </div>
                    <div class="total-card formation">
                        <h3>Formation</h3>
                        <div class="time" id="tFormation">00:00:00</div>
                    </div>
                    <div class="total-card brief">
                        <h3>Briefing</h3>
                        <div class="time" id="tBrief">00:00:00</div>
                    </div>
                    <div class="total-card deco">
                        <h3>D√©connect√©</h3>
                        <div class="time" id="tDeco">00:00:00</div>
                    </div>
                </div>

                <div class="logout-section">
                    <button class="btn-logout" id="logoutBtn">D√©connexion</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
<script>
// Configuration Supabase
const SUPABASE_URL = "https://azqbdnhgyolmwmvxfowb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cWJkbmhneW9sbXdtdnhmb3diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MzkzNDMsImV4cCI6MjA3NjExNTM0M30.swJva7IonZm-hwE40-udUBZTrCmtj8xeaFCtcPNoC9Q";

// Initialisation Supabase
let supabase;
try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase initialis√©');
} catch (error) {
    console.error('‚ùå Erreur Supabase:', error);
}

// Variables globales
let current = null;
let totals = {'En prod':0,'Pause':0,'Formation':0,'Brief':0,'D√©connect√©':0};
let dayKey = null;
let elapsedTimer = null;
let clockTimer = null;
let currentUser = null;

// Outils
function fmtHMS(s){
    const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function msToSec(ms){return Math.floor(ms/1000);}
function todayKey(d=new Date()){return d.toISOString().split('T')[0];}

// Fonction pour mettre √† jour l'apparence des boutons ET le fond
function updateButtonsAppearance(selectedStatus) {
    const buttons = {
        'En prod': document.getElementById('btnProd'),
        'Pause': document.getElementById('btnPause'),
        'Formation': document.getElementById('btnFormation'),
        'Brief': document.getElementById('btnBrief'),
        'D√©connect√©': document.getElementById('btnDeco')
    };
    
    // R√©initialiser tous les boutons
    Object.values(buttons).forEach(btn => {
        if (btn) btn.classList.remove('active');
    });
    
    // Activer le bouton s√©lectionn√©
    if (selectedStatus && buttons[selectedStatus]) {
        buttons[selectedStatus].classList.add('active');
    }
    
    // Mettre √† jour le fond de la page selon le statut
    updateBackground(selectedStatus);
}

// Fonction pour changer le fond selon le statut
function updateBackground(status) {
    const body = document.body;
    
    // Retirer toutes les classes de statut
    body.classList.remove('status-prod', 'status-pause', 'status-formation', 'status-brief', 'status-deco');
    
    // Ajouter la classe correspondante au statut
    if (status) {
        body.classList.add(`status-${status.toLowerCase().replace('√©', 'e').replace(' ', '-')}`);
    }
}

// Le reste du code JavaScript reste IDENTIQUE √† votre version fonctionnelle...
// [VOTRE CODE JAVASCRIPT EXISTANT ICI - je ne le modifie pas comme demand√©]

// Initialisation
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ MY SHIFT - D√©marrage');
    
    // √âl√©ments DOM
    const elements = {
        loginView: document.getElementById('loginView'),
        appView: document.getElementById('appView'),
        firstName: document.getElementById('firstName'),
        lastName: document.getElementById('lastName'),
        email: document.getElementById('email'),
        password: document.getElementById('password'),
        loginBtn: document.getElementById('loginBtn'),
        loginError: document.getElementById('loginError'),
        agentName: document.getElementById('agentName'),
        clock: document.getElementById('clock'),
        date: document.getElementById('date'),
        statusText: document.getElementById('statusText'),
        appSyncStatus: document.getElementById('appSyncStatus'),
        btnProd: document.getElementById('btnProd'),
        btnPause: document.getElementById('btnPause'),
        btnFormation: document.getElementById('btnFormation'),
        btnBrief: document.getElementById('btnBrief'),
        btnDeco: document.getElementById('btnDeco'),
        logoutBtn: document.getElementById('logoutBtn'),
        tProd: document.getElementById('tProd'),
        tPause: document.getElementById('tPause'),
        tFormation: document.getElementById('tFormation'),
        tBrief: document.getElementById('tBrief'),
        tDeco: document.getElementById('tDeco'),
        togglePassword: document.getElementById('togglePassword'),
        syncStatus: document.getElementById('syncStatus')
    };

    // V√©rifier la session existante
    await checkExistingSession();

    // ≈íil mot de passe
    elements.togglePassword.addEventListener('click', function() {
        const isPassword = elements.password.type === 'password';
        elements.password.type = isPassword ? 'text' : 'password';
        this.textContent = isPassword ? 'üîí' : 'üëÅÔ∏è';
    });

    // Connexion
    elements.loginBtn.addEventListener('click', handleLogin);

    // Boutons statut
    elements.btnProd.addEventListener('click', () => setStatus('En prod'));
    elements.btnPause.addEventListener('click', () => setStatus('Pause'));
    elements.btnFormation.addEventListener('click', () => setStatus('Formation'));
    elements.btnBrief.addEventListener('click', () => setStatus('Brief'));
    elements.btnDeco.addEventListener('click', () => setStatus('D√©connect√©'));

    // D√©connexion
    elements.logoutBtn.addEventListener('click', handleLogout);

    // Enter pour connexion
    [elements.firstName, elements.lastName, elements.email, elements.password].forEach(input => {
        input.addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') handleLogin(); 
        });
    });
});

// V√©rifier la session existante
async function checkExistingSession() {
    try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;
        
        if (session?.user) {
            console.log('‚úÖ Session existante:', session.user.email);
            currentUser = session.user;
            
            const userMetadata = currentUser.user_metadata;
            document.getElementById('firstName').value = userMetadata?.first_name || '';
            document.getElementById('lastName').value = userMetadata?.last_name || '';
            document.getElementById('email').value = currentUser.email || '';
            
            await onLogin();
        } else {
            document.getElementById('syncStatus').textContent = 'Pr√™t √† se connecter';
        }
    } catch (error) {
        console.log('Aucune session:', error.message);
        document.getElementById('syncStatus').textContent = 'Pr√™t √† se connecter';
    }
}

// Gestion connexion
async function handleLogin() {
    const elements = {
        firstName: document.getElementById('firstName'),
        lastName: document.getElementById('lastName'),
        email: document.getElementById('email'),
        password: document.getElementById('password'),
        loginError: document.getElementById('loginError'),
        syncStatus: document.getElementById('syncStatus')
    };

    const email = elements.email.value.trim();
    const password = elements.password.value.trim();
    const firstName = elements.firstName.value.trim();
    const lastName = elements.lastName.value.trim();

    if(!email || !password || !firstName || !lastName){
        elements.loginError.style.display = 'block';
        elements.loginError.textContent = 'Veuillez remplir tous les champs';
        return;
    }

    try {
        elements.loginError.style.display = 'none';
        elements.syncStatus.textContent = 'Connexion en cours...';

        // Essayer de se connecter
        const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (signInError) {
            // Cr√©er un nouveau compte
            const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        first_name: firstName,
                        last_name: lastName
                    }
                }
            });

            if (signUpError) throw signUpError;
            
            currentUser = signUpData.user;
            
            // Cr√©er le profil utilisateur
            await supabase.from('profiles').insert([
                {
                    id: currentUser.id,
                    email: email,
                    first_name: firstName,
                    last_name: lastName
                }
            ]);
            
            elements.syncStatus.textContent = 'Compte cr√©√© !';
            setTimeout(async () => {
                await onLogin();
            }, 2000);
        } else {
            currentUser = signInData.user;
            elements.syncStatus.textContent = 'Connexion r√©ussie !';
            await onLogin();
        }
        
    } catch (error) {
        console.error('‚ùå Erreur connexion:', error);
        elements.loginError.style.display = 'block';
        elements.loginError.textContent = 'Erreur: ' + error.message;
        elements.syncStatus.textContent = 'Erreur de connexion';
    }
}

// Apr√®s connexion
async function onLogin(){
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').style.display = 'block';
    
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    document.getElementById('agentName').textContent = `${firstName} ${lastName}`;
    
    dayKey = todayKey();
    startClock();
    await loadDataFromSupabase();
    startAutoSave();
}

// Chargement depuis Supabase
async function loadDataFromSupabase(){
    const appSyncStatus = document.getElementById('appSyncStatus');
    
    try {
        appSyncStatus.textContent = 'Chargement des donn√©es...';
        
        const { data, error } = await supabase
            .from('shifts')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('day_key', dayKey)
            .maybeSingle();

        if (error) throw error;

        if (data) {
            console.log('‚úÖ Donn√©es charg√©es depuis Supabase');
            
            totals = {
                'En prod': data.en_prod || 0,
                'Pause': data.pause || 0,
                'Formation': data.formation || 0,
                'Brief': data.brief || 0,
                'D√©connect√©': data.deconnecte || 0
            };
            
            if (data.current_status && data.current_start) {
                current = { 
                    status: data.current_status, 
                    start: new Date(data.current_start) 
                };
                updateButtonsAppearance(data.current_status);
            }
            
            appSyncStatus.textContent = 'Donn√©es synchronis√©es';
        } else {
            console.log('üÜï Nouvelle journ√©e');
            await saveToSupabase();
            appSyncStatus.textContent = 'Nouvelle session d√©marr√©e';
        }

        updateStatusDisplay();
        updateTotalsUI();
        startElapsedLoop();
        
    } catch (error) {
        console.error('‚ùå Erreur chargement:', error);
        appSyncStatus.textContent = 'Erreur chargement - Mode local';
        updateStatusDisplay();
        updateTotalsUI();
        startElapsedLoop();
    }
}

// Sauvegarde vers Supabase
async function saveToSupabase() {
    const appSyncStatus = document.getElementById('appSyncStatus');
    
    try {
        const dataToSave = {
            user_id: currentUser.id,
            day_key: dayKey,
            email: currentUser.email,
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            en_prod: totals['En prod'],
            pause: totals['Pause'],
            formation: totals['Formation'],
            brief: totals['Brief'],
            deconnecte: totals['D√©connect√©'],
            current_status: current ? current.status : null,
            current_start: current ? current.start.toISOString() : null
        };

        const { error } = await supabase
            .from('shifts')
            .upsert(dataToSave, { 
                onConflict: 'user_id,day_key'
            });

        if (error) throw error;

        console.log('‚úÖ Donn√©es sauvegard√©es sur Supabase');
        appSyncStatus.textContent = 'Sauvegard√©: ' + new Date().toLocaleTimeString();
        
    } catch (error) {
        console.error('‚ùå Erreur sauvegarde:', error);
        appSyncStatus.textContent = 'Erreur sauvegarde';
    }
}

// Changement de statut
async function setStatus(status){
    if(current){
        totals[current.status] += msToSec(Date.now()-current.start.getTime());
    }
    
    current = { status, start: new Date() };
    updateButtonsAppearance(status);
    updateStatusDisplay();
    updateTotalsUI();
    startElapsedLoop();
    
    await saveToSupabase();
}

// Les autres fonctions restent identiques...
function startClock(){
    const clockEl = document.getElementById('clock');
    const dateEl = document.getElementById('date');
    
    if(clockTimer) clearInterval(clockTimer);
    const now = new Date();
    clockEl.textContent = now.toLocaleTimeString('fr-FR',{hour12:false});
    dateEl.textContent = now.toLocaleDateString('fr-FR',{weekday:'long', year:'numeric', month:'long', day:'numeric'});
    clockTimer = setInterval(() => {
        const now = new Date();
        clockEl.textContent = now.toLocaleTimeString('fr-FR',{hour12:false});
    }, 1000);
}

function updateStatusDisplay(){
    const statusText = document.getElementById('statusText');
    const liveInfo = document.getElementById('liveInfo');
    
    if(current){
        const diff = msToSec(Date.now()-current.start.getTime());
        statusText.textContent = `${current.status} ‚Äî ${fmtHMS(diff)}`;
        liveInfo.textContent = `Statut actuel: ${current.status}`;
    } else {
        statusText.textContent = 'Aucun statut s√©lectionn√©';
        liveInfo.textContent = 'Choisissez un statut pour d√©marrer';
    }
}

function updateTotalsUI(){
    const run = current ? current.status : null;
    const elements = {
        'En prod': document.getElementById('tProd'),
        'Pause': document.getElementById('tPause'),
        'Formation': document.getElementById('tFormation'),
        'Brief': document.getElementById('tBrief'),
        'D√©connect√©': document.getElementById('tDeco')
    };
    
    for(const [s,el] of Object.entries(elements)){
        let sec = totals[s];
        if(run === s) sec += msToSec(Date.now()-current.start.getTime());
        el.textContent = fmtHMS(sec);
    }
}

function startElapsedLoop(){
    if(elapsedTimer) clearInterval(elapsedTimer);
    elapsedTimer = setInterval(() => {
        if(!current) return;
        updateStatusDisplay();
        updateTotalsUI();
    }, 1000);
}

function startAutoSave(){
    setInterval(async () => {
        if(currentUser) {
            await saveToSupabase();
        }
    }, 30000);
}

async function handleLogout(){
    const answer = confirm("Voulez-vous vraiment vous d√©connecter ?");
    if(!answer) return;
    
    if(current) {
        totals[current.status] += msToSec(Date.now()-current.start.getTime());
        await saveToSupabase();
    }
    
    await supabase.auth.signOut();
    location.reload();
}
</script>
</body>
</html>